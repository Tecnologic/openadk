# This file is part of the OpenADK project. OpenADK is copyrighted
# material, please see the LICENCE file in the top-level directory.

include ${TOPDIR}/rules.mk

PKG_NAME:=		postgresql
PKG_VERSION:=		9.1.1
PKG_RELEASE:=		1
PKG_MD5SUM:=		93b293bd735bb99258c1bad7bc9b8f6c
PKG_DESCR:=		PostgreSQL database library
PKG_SECTION:=		db
PKG_BUILDDEP:=		zlib
PKG_URL:=		http://www.postgresql.org/
PKG_SITES:=		http://ftp.postgresql.org/pub/source/v9.1.1/

PKG_SUBPKGS:=		LIBPQ LIBPQ_DEV

include ${TOPDIR}/mk/package.mk

$(eval $(call PKG_template,LIBPQ,libpq,${PKG_VERSION}-${PKG_RELEASE},${PKG_DEPENDS},${PKG_DESCR},${PKG_SECTION}))
$(eval $(call PKG_template,LIBPQ_DEV,libpq-dev,${PKG_VERSION}-${PKG_RELEASE},${PKG_DEPENDS},${PKG_DESCR},${PKG_SECTION}))

BUILD_STYLE:=           manual
INSTALL_STYLE:=         manual
PKG_CONFIGURE_ARGS:=	--disable-integer-datetimes \
			--without-krb5 \
			--without-openssl \
			--without-pam \
			--without-perl \
			--without-python \
			--without-readline \
			--without-bonjour \
			--without-tcl \
			--with-system-tzdata=${STAGING_TARGET_DIR} \
			--with-zlib="yes"
CONFIGURE_ARGS+=	${PKG_CONFIGURE_ARGS}

pre-configure:
	(cd ${WRKBUILD}; rm -rf config.{cache,status} ; \
		./configure \
		--prefix=/usr \
		${PKG_CONFIGURE_ARGS} \
	);
	${MAKE} -C "${WRKBUILD}/src/bin/pg_config" \
		CC="${CC_FOR_BUILD}" \
		DESTDIR="${WRKINST}" \
		all install

do-build:
	${MAKE} -C "${WRKBUILD}/src/include" \
		DESTDIR="${WRKINST}" \
		all install
	${MAKE} -C "${WRKBUILD}/src/interfaces/libpq" \
		DESTDIR="${WRKINST}" \
		all install

libpq-install:
	${INSTALL_DIR} ${IDIR_LIBPQ}/usr/lib
	${CP} ${WRKINST}/usr/lib/libpq.so* ${IDIR_LIBPQ}/usr/lib

libpq-dev-install:
	${INSTALL_DIR} ${IDIR_LIBPQ_DEV}/usr/include
	${CP} ${WRKINST}/usr/include/* ${IDIR_LIBPQ_DEV}/usr/include
	${INSTALL_DIR} ${IDIR_LIBPQ_DEV}/usr/bin
	${INSTALL_BIN} ${WRKINST}/usr/bin/pg_config \
		${IDIR_LIBPQ_DEV}/usr/bin

include ${TOPDIR}/mk/pkg-bottom.mk
