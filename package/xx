cd "$(dirname "$0")"
export TOPDIR=$(realpath ..)
if gmake --help >/dev/null 2>&1; then
	export GMAKE=gmake
else
	export GMAKE=make
fi

rm -rf pkglist.d
mkdir pkglist.d
for a in */Makefile; do
	sd=${a%/*}
	cd $sd
	pa=$($GMAKE show=ALL_PKGOPTS)		# pa: all subpackage options
	for xu in $pa; do			# xu: package option uppercase
		x=$($GMAKE show=PKGNAME_$xu)	# x: subpackage name
		print -nr -- "$xu" >../pkglist.d/"$x"
	done
	cd ..
done

rm -f kdeps kaputt
for a in */Makefile; do
	sd=${a%/*}
	cd $sd
	deps=$($GMAKE show=PKG_DEPENDS)
	cd ..
	for dep in $deps; do
		if [[ $dep = kmod-* ]]; then
			print $sd $dep >>kdeps
			continue
		fi
		[[ -e pkglist.d/$dep ]] || print $sd $dep >>kaputt
	done
done
