#!/bin/sh
fs=$(grep -v "^#" /etc/fstab | grep "^/dev/${MDEV}[[:blank:]]"|awk '{ print $3}')
mnt=$(grep -v "^#" /etc/fstab | grep "^/dev/${MDEV}[[:blank:]]"|awk '{ print $2}')
procfs=$fs
if [ $fs = "ntfs-3g" ];then
	procfs=fuse
fi

# fstab check
adk_check() {
	grep -v "^#" /etc/fstab | grep -q "^/dev/${MDEV}[[:blank:]]"
	if [ $? -ne 0 ];then
		logger -t fs -s "Disk ${MDEV} not registered in /etc/fstab"
		exit 1
	fi
}

# filesystem check
adk_fsck() {
	[ -x /usr/sbin/fsck.$fs ] && {
		logger -t fs -s "Checking $fs filesystem on ${MDEV}"
			fsck -p -t $fs ${MDEV}
	}
}

# mount filesystem
adk_mount() {
	mkdir -p $mnt >/dev/null 2>&1
	grep $procfs /proc/filesystems >/dev/null 2>&1
	if [ $? -eq 0 ];then
		logger -t fs -s "Mounting /dev/${MDEV} to $mnt"
		mount $mnt
	else
		logger -t fs -s "Required filesystem $procfs not available"
	fi
}

case "${ACTION}" in
add)
	logger -t fs -s "Device ${MDEV} added to the system"
	adk_check
	adk_fsck
	adk_mount
	;;
esac
exit 0
